open Oni_Core.Utility;
open Oni_Model;
open Oni_IntegrationTestLib;

// This test validates:
// - The 'oni-dev' extension gets activated
// - When typing in an 'oni-dev' buffer, the buffer received by the extension host
// is in sync with the buffer in the main process
runTestWithInput(
  ~name="ExtHostBufferOpen", (input, dispatch, wait, _runEffects) => {
  wait(~name="Capture initial state", (state: State.t) =>
    state.mode == Vim.Types.Normal
  );

  // Open an erroneous CSS file - verify we get some diagnostics
  dispatch(Actions.OpenFileByPath("integration_test/erroneous.css", None, None));

  // TODO: Fix diagnostics on Windows!
  if (!Sys.win32) {
    // Should get an error diagnostic
    wait(
      ~timeout=30.0,
      ~name=
        "Validate a diagnostic showed up, since our current input is erroneous",
      (state: State.t) => {
        let bufferOpt = Selectors.getActiveBuffer(state);

        switch (bufferOpt) {
        | Some(buffer) =>
          let diags =
            Model.Diagnostics.getDiagnostics(state.diagnostics, buffer);
          List.length(diags) > 0;
        | _ => false
        };
      },
    );
  };
});
