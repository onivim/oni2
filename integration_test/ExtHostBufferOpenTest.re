open Oni_Model;
open Oni_IntegrationTestLib;

module TS = TextSynchronization;

// This test validates:
// - The 'oni-dev' extension gets activated
// - When typing in an 'oni-dev' buffer, the buffer received by the extension host
// is in sync with the buffer in the main process
runTestWithInput(
  ~name="ExtHostBufferOpen", (_input, dispatch, wait, _runEffects) => {
  wait(~name="Capture initial state", (state: State.t) =>
    Feature_Vim.mode(state.vim) == Vim.Types.Normal
  );

  // Wait until the extension is activated
  // Give some time for the exthost to start
  wait(
    ~timeout=30.0,
    ~name="Validate the 'oni-dev' extension gets activated",
    (state: State.t) =>
    List.exists(
      id => id == "oni-dev-extension",
      state.extensions.activatedIds,
    )
  );

  let testFile = getAssetPath("some-test-file.txt");

  // Open an erroneous CSS file - verify we get some diagnostics
  dispatch(Actions.OpenFileByPath(testFile, None, None));

  let () =
    TS.validateTextIsSynchronized(
      ~expectedText=Some("abc| def|  ghi|"),
      ~description="Validate text model is consistent",
      dispatch,
      wait,
    );
  ();
});
